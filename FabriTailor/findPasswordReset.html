<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>找回密码 - FabriTailor</title>
    <link href="css/animate.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <link href="css/findPassword.css" rel="stylesheet" />
    <script src="js/modernizr.js"></script>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/jquery.alert.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/common.js"></script>
</head>
<body>
    <header>
        <div class="header-container">
            <a class="menu-btn show-on-small" href="javascript:void(0);"><img src="img/menu-btn.png" /></a>
            <div class="logo">
                <img src="img/logo.png" />
            </div>
            <nav class="hide-on-small">
                <ul>
                    <li><a href="javascript:void(0);"><span>在线定制</span></a></li>
                    <li><a href="javascript:void(0);"><span>关于我们</span></a></li>
                    <li><a href="javascript:void(0);"><span>凡布风尚</span></a></li>
                    <li><a href="javascript:void(0);"><span>休闲衬衫</span></a></li>
                    <li><a href="javascript:void(0);"><span>我们的凡布</span></a></li>
                </ul>
            </nav>
            <div class="btn-group hide-on-small">
                <a href="javascript:void(0);" class="register">从这里开始</a><a href="javascript:void(0);" class="login">登录</a>
            </div>
        </div>
    </header>
    <aside class="show-on-small">
        <a href="javascript:void(0);" class="btn-close"><img src="img/menu-btn-close.png" /></a>
        <ul>
            <li><a href="javascript:void(0);"><span>在线定制</span></a></li>
            <li><a href="javascript:void(0);"><span>关于我们</span></a></li>
            <li><a href="javascript:void(0);"><span>凡布风尚</span></a></li>
            <li><a href="javascript:void(0);"><span>休闲衬衫</span></a></li>
            <li><a href="javascript:void(0);"><span>我们的凡布</span></a></li>
            <li><a class="button" href="javascript:void(0);">从这里开始</a></li>
        </ul>
    </aside>
    <div class="main-container">
        <h1>设置新密码</h1>
        <p>请输入验证码和你的新密码。</p>
        <div class="stepForm">
            <div class="form-control">
                <input name="captcha" class="input" type="text" placeholder="验证码" required />
                <div class="tooltip">验证码错误</div>
            </div>
            <div class="form-control">
                <input name="newPassword" class="input" type="password" placeholder="创建新的密码" autocomplete="off" min="6" max="20" required />
                <div class="tooltip">密码应由6-20位字符组成</div>
            </div>
            <div class="form-control">
                <input name="rePassword" class="input" type="password" placeholder="确认新密码" autocomplete="off" required />
                <div class="tooltip">确认新密码错误</div>
            </div>
            <div class="control-group">
                <div class="form-control">
                    <input name="imgcaptcha" class="input" type="text" placeholder="图片验证码" required />
                    <div class="tooltip">验证码错误</div>
                </div>
                <div class="form-control">
                    <a class="captcha-img" href="javascript:void(0);"><img src="img/bookSuccess4.jpg" /></a>
                </div>
            </div>
            <a href="javascript:void(0);" class="button">保存</a>
        </div>
        <div class="stepForm success hidden">
            <a href="${base}/login.jhtml" class="button">登录</a>
        </div>
    </div>
    <footer>
        <div class="contact">
            <h3 class="hide-on-small">与凡布保持联系</h3>
            <div class="input-group hide-on-small">
                <input class="input" type="text" placeholder="请输入您的邮件地址" />
                <a href="javascript:void(0);" class="btn">»</a>
            </div>
            <div class="ico-link text-center-on-small">
                <a href="javascript:void(0);"><img src="img/ico-email.jpg" /></a>
                <a href="javascript:void(0);"><img src="img/ico-weibo.png" /></a>
                <a href="javascript:void(0);"><img src="img/ico-weixin.png" /></a>
                <a href="javascript:void(0);"><img src="img/ico-taobao.png" /></a>
            </div>
        </div>
        <div class="links text-center-on-small">
            <div class="row">
                <div class="col-md-3 col-sm-12">
                    <h6>FabriTailor.com</h6>
                    <ul>
                        <li>
                            <a href="javascript:void(0);">
                                北京市<br />
                                朝阳区<br />
                                夏家园18号楼<br />
                                2091室
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-12">
                    <h6>凡布制衣</h6>
                    <ul>
                        <li><a href="javascript:void(0);">关于我们</a></li>
                        <li><a href="javascript:void(0);">人才招聘</a></li>
                        <li><a href="javascript:void(0);">成为凡布量体师</a></li>
                        <li><a href="javascript:void(0);">服务条款</a></li>
                        <li><a href="javascript:void(0);">隐私声明</a></li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-12">
                    <h6>帮助</h6>
                    <ul>
                        <li><a href="javascript:void(0);">购物指南</a></li>
                        <li><a href="javascript:void(0);">关于量体定制</a></li>
                        <li><a href="javascript:void(0);">常见问题解答</a></li>
                        <li><a href="javascript:void(0);">帮助与支持</a></li>
                        <li><a href="javascript:void(0);">退换货信息</a></li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-12">
                    <h6>在线商店</h6>
                    <ul>
                        <li><a href="javascript:void(0);">衬衫</a></li>
                        <li><a href="javascript:void(0);">查看全部</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="logo">
            <img src="img/logo-footer.png" />
        </div>
    </footer>
    <div class="login-panel">
        <h2>登录</h2>
        <input class="input" type="text" placeholder="请输入电子邮件地址" />
        <input class="input" type="password" placeholder="请输入密码" />
        <a class="button" href="javascript:void(0);">登陆</a>
        <a href="javascript:void(0);">忘记密码，或立即免费注册成为会员？</a>
    </div>
    <div class="cover-small-black"></div>
    <div class="login-cover-black"></div>
    <script type="text/javascript">
        var $h1 = $(".main-container > h1"),
            $p = $(".main-container > p"),
            $stepForm = $(".main-container .stepForm").first(),
            $stepFormSuccess = $(".main-container .stepForm.success"),
            $newPassword = $stepForm.find("input[name=newPassword]"),
            $rePassword = $stepForm.find("input[name=rePassword]"),
            $imgCaptcha = $stepForm.find("input[name=imgcaptcha]"),
            $captcha = $stepForm.find("input[name=captcha]");
        var stepImageCaptchaRefresh = function () {
            $stepForm.find("a.captcha-img img").attr("src", "${base}/common/captcha.jhtml?captchaId=${captchaId}&timestamp=" + (new Date()).valueOf());
        };
        var doSubmit = function () {
            if ($(this).hasClass("disabled"))
                return;
            var hasError = 0;
            $stepForm.find(".form-control input").each(function (i, e) {
                var $this = $(this),
                    $control = $this.parent();
                if ($this.prop("required") && (!$this.val() || $this.val().length == 0)) {
                    $control.addClass("has-error");
                    hasError++;
                }
                else if ($this.attr("min") && $this.val() && $this.val().length < parseInt($this.attr("min"))) {
                    $control.addClass("has-error");
                    hasError++;
                }
                else if ($this.attr("max") && $this.val() && $this.val().length > parseInt($this.attr("max"))) {
                    $control.addClass("has-error");
                    hasError++;
                }
                else {
                    $control.removeClass("has-error");
                }
            });
            if ($newPassword.prop("required") && $newPassword.val() != $rePassword.val()) {
                $rePassword.parent().addClass("has-error");
                hasError++;
            }
            if (hasError == 0) {
                //提交信息
                $stepForm.children("a.button").addClass("disabled");
                //$.ajax({
                //    url: "${base}/common/public_key.jhtml",
                //    type: "GET",
                //    dataType: "json",
                //    cache: false,
                //    success: function (data) {
                        var params = {
                            username: "${member.username}",
                            newPassword: $newPassword.val(),
                            key: $captcha.val()
                        };
                        params.captchaId = "${captchaId}";
                        params.captcha = $imgCaptcha.val();
                        //var rsaKey = new RSAKey();
                        //rsaKey.setPublic(b64tohex(data.modulus), b64tohex(data.exponent));
                        //params.enPassword = hex2b64(rsaKey.encrypt($newPassword.val()));
                        $.ajax({
                            url: "${base}/password/reset.jhtml",
                            type: "POST",
                            data: params,
                            dataType: "json",
                            cache: false,
                            traditional: true,
                            success: function (data) {
                                if (data && data.type == "success") {
                                    $.alert.success("保存成功。");
                                    $stepForm.addClass("hidden");
                                    $stepFormSuccess.removeClass("hidden");
                                    $h1.text("新密码已保存");
                                    $p.text("请重新登录");
                                }
                                else {
                                    $.alert.error("保存失败。" + (data && data.content ? data.content : ""));
                                }
                            },
                            error: function () {
                                $.alert.error("保存失败。");
                            }
                        }).always(function () {
                            $stepForm.children("a.button").removeClass("disabled");
                        });
                //    }
                //}).fail(function () {
                //    $.alert.error("保存失败。");
                //    $stepForm.children("a.button").removeClass("disabled");
                //});
            }
        };
        $stepForm.find("a.button").click(doSubmit);
        $stepForm.find("a.captcha-img").click(stepImageCaptchaRefresh);
    </script>
</body>
</html>
