<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>FabriTailor</title>
    <link href="css/animate.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <link href="css/cart.css" rel="stylesheet" />
    <script src="js/modernizr.js"></script>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/jquery.alert.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/jquery.lazyload.js"></script>
    <script src="js/common.js"></script>
</head>
<body>
    <header>
        <div class="header-container">
            <a class="menu-btn show-on-small" href="javascript:void(0);"><img src="img/menu-btn.png" /></a>
            <div class="logo">
                <img src="img/logo.png" />
            </div>
            <nav class="hide-on-small">
                <ul>
                    <li><a href="javascript:void(0);"><span>在线定制</span></a></li>
                    <li><a href="javascript:void(0);"><span>关于我们</span></a></li>
                    <li><a href="javascript:void(0);"><span>凡布风尚</span></a></li>
                    <li><a href="javascript:void(0);"><span>休闲衬衫</span></a></li>
                    <li><a href="javascript:void(0);"><span>我们的凡布</span></a></li>
                </ul>
            </nav>
            <div class="btn-group hide-on-small">
                <a href="javascript:void(0);" class="register">从这里开始</a><a href="javascript:void(0);" class="login">登录</a>
            </div>
        </div>
    </header>
    <aside class="show-on-small">
        <a href="javascript:void(0);" class="btn-close"><img src="img/menu-btn-close.png" /></a>
        <ul>
            <li><a href="javascript:void(0);"><span>首页</span></a></li>
            <li>
                <a href="javascript:void(0);"><span>在线定制</span><i class="showhide"></i></a>
                <div class="sub-menu opened clearfix">
                    <a href="javascript:void(0);">查看全部</a>
                    <a href="javascript:void(0);">查看全部</a>
                    <a href="javascript:void(0);">查看全部</a>
                </div>
            </li>
            <li class="login"><a href="javascript:void(0);"><span>登录</span></a></li>
            <li class="logout hidden"><a href="javascript:void(0);"><span>登出</span></a></li>
            <li><a href="javascript:void(0);"><span>关于我们</span></a></li>
            <li><a href="javascript:void(0);"><span>凡布风尚</span></a></li>
            <li><a href="javascript:void(0);"><span>休闲衬衫</span></a></li>
            <li><a href="javascript:void(0);"><span>我们的凡布</span></a></li>
            <li class="account hidden">
                <a href="javascript:void(0);"><span>我的账号</span><i class="showhide"></i></a>
                <div class="sub-menu fadeInDownFast clearfix">
                    <a href="${base}/member/index.jhtml">账户信息</a>
                    <a href="${base}/member/order/list.jhtml">我的订单</a>
                    <a href="${base}/member/size/list.jhtml">我的尺寸</a>
                    <a href="${base}/member/specification/list.jhtml">我的板型</a>
                    <a href="${base}/member/receiver/list.jhtml">地址簿</a>
                    <a href="javascript:void(0);">退换货</a>
                </div>
            </li>
            <li class="register"><a class="button" href="javascript:void(0);">从这里开始</a></li>
        </ul>
    </aside>
    <div class="main-container">
        <div class="cart-categories">
            <h1>购物车</h1>
        </div>
        <div class="cart-empty">
            购物车是空的
        </div>
        <div class="products">
            <div class="product" data-id="${orderItem.id}" data-qty="${orderItem.quantity}" data-price="${orderItem.subtotal}">
                <div class="title clearfix">
                    <h3>Hume</h3>
                    <div class="image">
                        <img src="img/product-detail1.jpg" />
                    </div>
                    <span>100%纯棉 小条纹格</span>
                    <a class="close" href="javascript:void(0);"></a>
                </div>
                <div class="detail">
                    <div class="build-name">
                        <ul class="clearfix">
                            <li>我的版型</li>
                            <li><a href="javascript:void(0);">编辑版型</a></li>
                        </ul>
                    </div>
                    <div class="build-content">
                        <ul class="clearfix">
                            <li>标准版</li>
                            <li>经典扣领</li>
                            <li>圆角袖口</li>
                            <li>无口袋</li>
                            <li>明门襟</li>
                            <li>无褶</li>
                            <li>加长</li>
                            <li>无刺绣</li>
                        </ul>
                    </div>
                    <div class="purchase-info">
                        <div class="qty">
                            <span>数量</span><input name="qty" class="input" type="text" value="1" />
                        </div>
                        <div class="price">
                            ￥999.00
                        </div>
                    </div>
                </div>
            </div>
            <div class="product">
                <div class="title clearfix">
                    <h3>Hume</h3>
                    <div class="image">
                        <img src="img/product-detail1.jpg" />
                    </div>
                    <span>100%纯棉 小条纹格</span>
                    <a class="close" href="javascript:void(0);"></a>
                </div>
                <div class="detail">
                    <div class="build-name">
                        <ul class="clearfix">
                            <li>我的版型</li>
                            <li><a href="javascript:void(0);">编辑版型</a></li>
                        </ul>
                    </div>
                    <div class="build-content">
                        <ul class="clearfix">
                            <li>标准版</li>
                            <li>经典扣领</li>
                            <li>圆角袖口</li>
                            <li>无口袋</li>
                            <li>明门襟</li>
                            <li>无褶</li>
                            <li>加长</li>
                            <li>无刺绣</li>
                        </ul>
                    </div>
                    <div class="purchase-info clearfix">
                        <div class="qty">
                            <span>数量</span><input name="qty" class="input" type="text" value="1" />
                        </div>
                        <div class="price">
                            ￥999.00
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="purchase row">
            <div class="col-md-4 col-sm-12">
                <h2>支付方式</h2>
                <div class="order-info">
                    <div class="radio clearfix">
                        <input name="paymentMethod" type="radio" value="alipay" />
                        <span></span>
                        <h4>支付宝</h4>
                        <p>支付宝描述</p>
                    </div>
                    <div class="radio clearfix">
                        <input name="paymentMethod" type="radio" value="weichatpay" />
                        <span></span>
                        <h4>微信</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-12">
                <h2>收货地址</h2>
                <div class="address-info">
                    <label>地址</label>
                    <select name="address_id" class="select">
                        <option value="">新建</option>
                    </select>
                    <div class="address-edit hidden">
                        <a href="javascript:void(0);">编辑地址</a>
                    </div>
                    <div class="address-form">
                        <label>姓名</label>
                        <input name="name" class="input" type="text" required />
                        <label class="margin">省市</label>
                        <select name="province" class="select" required>
                            <option value="">省市</option>
                        </select>
                        <label>区县</label>
                        <select name="city" class="select" required>
                            <option value="">区县</option>
                        </select>
                        <label class="margin">地址</label>
                        <input name="addr" class="input" type="text" required />
                        <label class="margin">联系电话</label>
                        <input name="tel" class="input" type="text" required />
                        <label class="margin">微信</label>
                        <input name="weichat" class="input" type="text" />
                        <div class="checkbox">
                            <input id="accountAddressIsDefault" class="checkbox" type="checkbox" />
                            <label for="accountAddressIsDefault">设为默认</label>
                        </div>
                        <div class="clearfix">
                            <a class="button" href="javascript:void(0);">保存</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-12">
                <h2>总计</h2>
                <div class="total">
                    <dl>
                        <dt>金额</dt>
                        <dd>¥24.00</dd>
                        <dt>优惠</dt>
                        <dd class="warn">¥0.00</dd>
                        <dt>返现</dt>
                        <dd>¥0.00</dd>
                        <dt>运费</dt>
                        <dd>¥10.00</dd>
                    </dl>
                    <dl class="sum">
                        <dt>总额</dt>
                        <dd>¥34.00</dd>
                    </dl>
                    <div class="clearfix">
                        <a class="button disabled" href="javascript:void(0);">购买</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="wait-panel qr-code">
        <h2>在新窗口中完成支付</h2>
        <img src="img/bookSuccess3.jpg" />
        <a class="button" href="javascript:void(0);">已完成支付</a>
        <a href="javascript:void(0);">支付遇到问题？</a>
    </div>
    <div class="wait-cover-black"></div>
    <footer>
        <div class="contact">
            <h3 class="hide-on-small">与凡布保持联系</h3>
            <div class="input-group hide-on-small">
                <input class="input" type="text" placeholder="请输入您的邮件地址" />
                <a href="javascript:void(0);" class="btn">»</a>
            </div>
            <div class="ico-link text-center-on-small">
                <a href="javascript:void(0);"><img src="img/ico-email.jpg" /></a>
                <a href="javascript:void(0);"><img src="img/ico-weibo.png" /></a>
                <a href="javascript:void(0);"><img src="img/ico-weixin.png" /></a>
                <a href="javascript:void(0);"><img src="img/ico-taobao.png" /></a>
            </div>
        </div>
        <div class="links text-center-on-small">
            <div class="row">
                <div class="col-md-3 col-sm-12">
                    <h6>FabriTailor.com</h6>
                    <ul>
                        <li>
                            <a href="javascript:void(0);">
                                北京市<br />
                                朝阳区<br />
                                夏家园18号楼<br />
                                2091室
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-12">
                    <h6>凡布制衣</h6>
                    <ul>
                        <li><a href="javascript:void(0);">关于我们</a></li>
                        <li><a href="javascript:void(0);">人才招聘</a></li>
                        <li><a href="javascript:void(0);">成为凡布量体师</a></li>
                        <li><a href="javascript:void(0);">服务条款</a></li>
                        <li><a href="javascript:void(0);">隐私声明</a></li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-12">
                    <h6>帮助</h6>
                    <ul>
                        <li><a href="javascript:void(0);">购物指南</a></li>
                        <li><a href="javascript:void(0);">关于量体定制</a></li>
                        <li><a href="javascript:void(0);">常见问题解答</a></li>
                        <li><a href="javascript:void(0);">帮助与支持</a></li>
                        <li><a href="javascript:void(0);">退换货信息</a></li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-12">
                    <h6>在线商店</h6>
                    <ul>
                        <li><a href="javascript:void(0);">衬衫</a></li>
                        <li><a href="javascript:void(0);">查看全部</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="logo">
            <img src="img/logo-footer.png" />
        </div>
    </footer>
    <div class="login-panel">
        <h2>登录</h2>
        <input class="input" type="text" placeholder="请输入电子邮件地址" />
        <input class="input" type="password" placeholder="请输入密码" />
        <a class="button" href="javascript:void(0);">登陆</a>
        <a href="javascript:void(0);">忘记密码，或立即免费注册成为会员？</a>
    </div>
    <div class="cover-small-black"></div>
    <div class="login-cover-black"></div>
    <script type="text/javascript">
        //侧边栏
        $("header .menu-btn").click(function () {
            $("aside").addClass("opened");
            $("div.cover-small-black").addClass("opened").fadeTo("normal", 0.5, EASING_NAME);
        });
        $("aside .btn-close").click(function () {
            $("aside").removeClass("opened");
            $("div.cover-small-black").fadeTo("normal", 0, EASING_NAME, function () { $(this).removeClass("opened"); });
        });
        var asideSubMenuInit = function (el) {
            var $li = $(el),
                $a = $li.children("a"),
                $subMenu = $li.children(".sub-menu");
            $a.click(function (e) {
                e.preventDefault();
                $a.next().toggleClass("opened").end().children("i.showhide").toggleClass("mins");
            });
        };
        asideSubMenuInit($("body > aside ul li.account"));
        //登陆
        var showLogin = function () {
            $(".login-panel").show();
            $("div.login-cover-black").addClass("opened").fadeTo("normal", 0.5, EASING_NAME);
        };
        var hideLogin = function () {
            $(".login-panel").hide();
            $("div.login-cover-black").fadeTo("normal", 0, EASING_NAME, function () { $(this).removeClass("opened"); });
        };
        $("div.login-cover-black").click(hideLogin);
        $("header .btn-group .login").click(showLogin);
    </script>
    <script type="text/javascript">
        var cartToken = "${cartToken}",
            $products = $(".main-container .products"),
            $purchase = $(".main-container .purchase"),
            $paymentRadio = $purchase.find(".radio"),
            $addressInfo = $purchase.find(".address-info"),
            $addressEdit = $purchase.find(".address-edit"),
            $addressId = $addressInfo.find("select[name=address_id]"),
            $addressForm = $addressInfo.find(".address-form"),
            $name = $addressForm.find("input[name=name]"),
            $province = $addressForm.find("select[name=province]"),
            $city = $addressForm.find("select[name=city]"),
            $addr = $addressForm.find("input[name=addr]"),
            $tel = $addressForm.find("input[name=tel]"),
            $weichat = $addressForm.find("input[name=weichat]"),
            $isDefault = $("#accountAddressIsDefault"),
            $btnBuy = $purchase.find(".total a.button"),
            $waitPanel = $("body .wait-panel"),
            $waitPanelCover = $("body .wait-cover-black");
        var addressList = [
            {
                id: 1,
                consignee: "",
                provinceId: 1,
                cityId: 2,
                address: "",
                phone: "",
                isDefault: true
            }
        ];
        //修改商品数量
        var changeProductQty = function () {
            if ($(this).prop("disabled"))
                return false;
            var $input = $(this),
                $purchaseInfo = $input.parent().parent(),
                $price = $purchaseInfo.children(".price"),
                $product = $purchaseInfo.parent().parent();
            if (/^\d+$/.test($input.val())) {
                if (parseInt($input.val()) == parseInt($product.data("qty")))
                    return false;
                $input.prop("disabled", true);
                var params = {
                    id: $product.data("id"),
                    quantity: parseInt($input.val())
                };
                $.ajax({
                    url: "${base}/cart/edit.jhtml",
                    type: "POST",
                    data: params,
                    dataType: "json",
                    cache: false,
                    success: function (data) {
                        if (data && data.message && data.message.type == "success") {
                            $product.data("qty", $input.val());
                            if (typeof data.subtotal === "number") {
                                $price.text("￥" + data.subtotal.toFixed(2));
                            }
                            else {
                                $price.text("￥" + (parseInt($product.data("qty")) * parseFloat($product.data("price"))).toFixed(2));
                            }
                            if (data.cartToken) {
                                cartToken = data.cartToken;
                            }
                            doCalculate();
                        }
                        else {
                            $.alert.error("修改商品数量失败。" + (data && data.message && data.message.content ? data.message.content : ""));
                            $input.val($product.data("qty"));
                        }
                    },
                    error: function () {
                        $.alert.error("修改商品数量失败。");
                        $input.val($product.data("qty"));
                    }
                }).always(function () {
                    $input.removeProp("disabled");
                });
            }
            else {
                $input.val($product.data("qty"));
            }
        };
        //删除商品
        var delProduct = function () {
            if ($(this).prop("disabled"))
                return false;
            var $btnDel = $(this),
                $product = $btnDel.parent().parent();
            $btnDel.addClass("disabled");
            $.ajax({
                url: "${base}/cart/delete.jhtml",
                type: "POST",
                data: { id: $product.data("id") },
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data && data.message && data.message.type == "success") {
                        $product.fadeTo("normal", 0, function () {
                            $(this).remove();
                            if ($products.find(".product").length == 0) {
                                window.location.reload();
                            }
                        });
                        if (data.cartToken) {
                            cartToken = data.cartToken;
                        }
                        doCalculate();
                    }
                    else {
                        $.alert.error("删除商品失败。" + (data && data.message && data.message.content ? data.message.content : ""));
                        $btnDel.removeClass("disabled");
                    }
                },
                error: function () {
                    $.alert.error("删除商品失败。");
                    $btnDel.removeClass("disabled");
                }
            });
        };
        //获取省市信息
        $.ajax({
            url: "${base}/common/area.jhtml",
            type: "GET",
            dataType: "json",
            cache: false,
            traditional: true,
            success: function (data) {
                if (data) {
                    for (var id in data) {
                        $province.append('<option value="' + id + '">' + data[id] + '</option>');
                    }
                    if ($province.data("value")) {
                        $province.val($province.data("value"));
                        $province.removeData("value");
                        $province.change();
                    }
                }
            }
        });
        //获取区县信息
        var getCityData = function () {
            $city.children("option").not(":eq(0)").remove();
            if ($province.val() && $province.val().length) {
                $.ajax({
                    url: "${base}/common/area.jhtml",
                    type: "GET",
                    data: { parentId: $province.val() },
                    dataType: "json",
                    cache: false,
                    traditional: true,
                    success: function (data) {
                        if (data) {
                            for (var id in data) {
                                $city.append('<option value="' + id + '">' + data[id] + '</option>');
                            }
                            if ($city.data("value")) {
                                $city.val($city.data("value"));
                                $city.removeData("value");
                            }
                        }
                    }
                });
            }
        };
        //设置表格信息
        var setFormValues = function (address) {
            if (address) {
                $name.val(address.consignee || "");
                if ($province.children("option").length > 1) {
                    $province.val(address.provinceId || "");
                    $province.change();
                }
                else {
                    $province.data("value", address.provinceId || "");
                }
                $city.data("value", address.cityId || "");
                $addr.val(address.address || "");
                $tel.val(address.phone || "");
                $isDefault.get(0).checked = address.isDefault;
            }
            else {
                $name.val("");
                $province.val("");
                $city.val("");
                $addr.val("");
                $tel.val("");
                $isDefault.get(0).checked = false;
            }
        };
        //更改地址选择
        var addressChange = function () {
            var id = $addressId.val();
            if (!id || id.length == 0) {
                setFormValues();
                $addressEdit.addClass("hidden");
                $addressForm.removeClass("hidden");
            }
            else {
                var isExists = false;
                for (var i = 0; i < addressList.length; i++) {
                    var address = addressList[i];
                    if (address.id == parseInt(id)) {
                        setFormValues(address);
                        isExists = true;
                        break;
                    }
                }
                if (!isExists)
                    setFormValues();
                $addressEdit.removeClass("hidden");
                $addressForm.addClass("hidden");
            }
            validateForm();
        };
        //编辑地址
        var showAddressUpdate = function () {
            $addressEdit.addClass("hidden");
            $addressForm.removeClass("hidden");
            validateForm();
        };
        //保存地址
        var saveAddress = function () {
            if ($(this).hasClass("disabled"))
                return;
            //表单验证
            var hasError = 0;
            $addressForm.find("input, select").each(function (i, e) {
                var $this = $(this),
                    $control = $this.is(".ckeckbox") ? $this.parent() : $this.prev("label");
                if ($this.prop("required") && (!$this.val() || $this.val().length == 0)) {
                    $control.addClass("has-error");
                    hasError++;
                }
                else {
                    $control.removeClass("has-error");
                }
            });
            if (hasError == 0) {
                var params = {
                    consignee: $name.val(),
                    areaName: $province.children("option:checked").text() + $city.children("option:checked").text(),
                    areaId: $city.val(),
                    address: $addr.val(),
                    phone: $tel.val(),
                    isDefault: $isDefault.get(0).checked
                };
                if ($weichat.val() && $weichat.val().length) {
                    params.weichat = $weichat.val();
                }
                $(this).addClass("disabled");
                if ($addressId.val() && $addressId.val().length) {
                    params.id = $addressId.val();
                    $.ajax({
                        url: "${base}/member/receiver/updatev2.jhtml",
                        type: "POST",
                        data: params,
                        dataType: "json",
                        cache: false,
                        traditional: true,
                        success: function (data) {
                            if (data && data.type == "success") {
                                var address = {
                                    id: parseInt($addressId.val(), 10),
                                    consignee: $name.val(),
                                    provinceId: parseInt($province.val(), 10),
                                    cityId: parseInt($city.val(), 10),
                                    address: $addr.val(),
                                    phone: $tel.val(),
                                    isDefault: $isDefault.get(0).checked
                                };
                                var isExists = false;
                                for (var i = 0; i < addressList.length; i++) {
                                    if (address.id == addressList[i].id) {
                                        $.extend(addressList[i], address);
                                        isExists = true;
                                        break;
                                    }
                                }
                                if (!isExists)
                                    addressList.push(address);
                                $addressId.children("option[value=" + address.id + "]").text(address.consignee);
                                $addressId.val(address.id).change();
                            }
                            else {
                                $.alert.error("保存失败。" + (data && data.content ? data.content : ""));
                            }
                        },
                        error: function () {
                            $.alert.error("保存失败。");
                        }
                    }).always(function () {
                        $addressForm.find("a.button").removeClass("disabled");
                    });
                }
                else {
                    $.ajax({
                        url: "${base}/member/receiver/savev2.jhtml",
                        type: "POST",
                        data: params,
                        dataType: "json",
                        cache: false,
                        traditional: true,
                        success: function (data) {
                            if (data && data.type == "success") {
                                var address = {
                                    id: parseInt(data.content, 10),
                                    consignee: $name.val(),
                                    provinceId: parseInt($province.val(), 10),
                                    cityId: parseInt($city.val(), 10),
                                    address: $addr.val(),
                                    phone: $tel.val(),
                                    isDefault: $isDefault.get(0).checked
                                };
                                addressList.push(address);
                                var $option = $('<option></option>');
                                $option.attr("value", address.id);
                                $option.text(address.consignee);
                                $addressId.append($option);
                                $addressId.val(address.id).change();
                            }
                            else {
                                $.alert.error("保存失败。" + (data && data.content ? data.content : ""));
                            }
                        },
                        error: function () {
                            $.alert.error("保存失败。");
                        }
                    }).always(function () {
                        $addressForm.find("a.button").removeClass("disabled");
                    });
                }
            }
        };
        //更改支付方式
        var paymentPluginChange = function () {
            var $radio = $(this).parent(),
                $container = $radio.parent(),
                val = $(this).val();
            if (!$container.data("val") || $container.data("val") != val) {
                $container.data("val", val);
                doCalculate();
                validateForm();
            }
        };
        //检测提交按钮状态
        var validateForm = function () {
            var isValide = true;
            if ($paymentRadio.find("input:checked").length == 0) {
                $paymentRadio.parent().addClass("has-error");
                isValide = false;
            }
            else {
                $paymentRadio.parent().removeClass("has-error");
            }
            if (!$addressId.val() || $addressId.val().length == 0) {
                //$addressId.prev().addClass("has-error");
                isValide = false;
            }
            else if($addressId.val() && $addressId.val().length > 0 && !$addressForm.hasClass("hidden")){
                isValide = false;
            }
            else {
                //$addressId.prev().removeClass("has-error");
            }
            if (isValide) {
                $btnBuy.removeClass("disabled");
            }
            else {
                $btnBuy.addClass("disabled");
            }
            return isValide;
        };
        //重新计算订单数据
        var doCalculate = function (callback) {
            $btnBuy.addClass("calculating");
            var params = {
                paymentMethodId: 1,
                shippingMethodId: 1
            };
            if ($paymentRadio.find("input:checked").length) {
                params.paymentPluginId = $paymentRadio.find("input:checked").val();
            }
            else if ($paymentRadio.length) {
                params.paymentPluginId = $paymentRadio.find("input").first().val();
            }
            $.ajax({
                url: "${base}/member/order/calculatev2.jhtml",
                type: "POST",
                data: params,
                dataType: "json",
                cache: false,
                traditional: true,
                success: function (data) {
                    if (data && data.message && data.message.type == "success") {
                        var total = $purchase.find(".total dd");
                        total.eq(0).text("￥" + (isNaN(parseFloat(data.price)) ? "0.00" : parseFloat(data.price).toFixed(2)));
                        total.eq(1).text("￥" + (isNaN(parseFloat(data.couponDiscount)) ? "0.00" : parseFloat(data.couponDiscount).toFixed(2)));
                        total.eq(2).text("￥" + (isNaN(parseFloat(data.promotionDiscount)) ? "0.00" : parseFloat(data.promotionDiscount).toFixed(2)));
                        total.eq(3).text("￥" + (isNaN(parseFloat(data.freight)) ? "0.00" : parseFloat(data.freight).toFixed(2)));
                        total.eq(3).text("￥" + (isNaN(parseFloat(data.tax)) ? "0.00" : parseFloat(data.tax).toFixed(2)));
                        total.last().text("￥" + (isNaN(parseFloat(data.amount)) ? "0.00" : parseFloat(data.amount).toFixed(2)));
                    }
                    if (typeof callback === "function")
                        callback.call(this, data);
                },
                error: function () {
                    if (typeof callback === "function")
                        callback.call(this, null);
                }
            }).always(function () {
                $btnBuy.removeClass("calculating");
            });
        };
        //提交订单
        var doSubmit = function () {
            if (!validateForm() || $(this).hasClass("loading"))
                return;
            var params = {
                cartToken: cartToken,
                receiverId: $addressId.val(),
                paymentMethodId: 1,
                paymentPluginId: $paymentRadio.find("input:checked").val(),
                shippingMethodId: 1
            };
            $btnBuy.addClass("loading");
            $.ajax({
                url: "${base}/member/order/createv2.jhtml",
                type: "POST",
                data: params,
                dataType: "json",
                async:false,
                cache: false,
                traditional: true,
                success: function (data) {
                    if (data && data.type == "success") {
                        orderId = data.content;
                        doPayment();
                    }
                    else {
                        $.alert.error("提交订单失败。" + (data && data.content ? data.content : ""));
                    }
                },
                error: function () {
                    $.alert.error("提交订单失败。");
                }
            }).always(function () {
                $btnBuy.removeClass("loading");
            });
        };
        //进行支付
        var doPayment = function () {
            var paymentPluginId = $paymentRadio.find("input:checked").val();
            if (paymentPluginId == "alipayDirectPlugin" || paymentPluginId == "alipayWapPlugin") {
                openWindow("${base}/payment/submit.jhtml?paymentPluginId=" + encodeURIComponent(paymentPluginId) + "&sn=" + encodeURIComponent(orderId));
                checkOrderStatus();
                //checkOrderLock();
                $waitPanel.children("a").attr("href", "${base}/member/order/viewv2.jhtml?sn=" + encodeURIComponent(orderId));
                $waitPanel.show();
                $waitPanelCover.addClass("opened").fadeTo("normal", 0.5, EASING_NAME);
            }
            else if (paymentPluginId == "tenpayNativePlugin") {
                $waitPanel.children("h2").text("正在生成二维码...");
                $waitPanel.children("a").hide().attr("href", "${base}/member/order/viewv2.jhtml?sn=" + encodeURIComponent(orderId));
                $waitPanel.show();
                $waitPanelCover.addClass("opened").fadeTo("normal", 0.5, EASING_NAME);
                $.ajax({
                    url: "${base}/payment/submitv2.jhtml",
                    type: "GET",
                    data: {
                        paymentPluginId: "tenpayNativePlugin",
                        sn: orderId
                    },
                    dataType: "json",
                    cache: false,
                    success: function (data) {
                        if (data && data.type == "success") {
                            var $qrImg = $("<img />");
                            $qrImg.attr("src", data.content);
                            $waitPanel.children("h2").after($qrImg);
                            $waitPanel.children("h2").text("扫描二维码");
                            $waitPanel.children("a").show();
                            $waitPanel.addClass("qr-code");
                            checkOrderStatus();
                            //checkOrderLock();
                        }
                        else {
                            $waitPanel.children("h2").text("支付遇到了问题");
                            $waitPanel.children("a").first().show().text("重新支付");
                        }
                    },
                    error: function () {
                        $waitPanel.children("h2").text("支付遇到了问题");
                        $waitPanel.children("a").first().show().text("重新支付");
                    }
                });
            }
            else if (paymentPluginId == "tenpayJsapiPlugin") {
                window.location.href = "${base}/payment/code.jhtml?sn=" + encodeURIComponent(orderId);
            }
            else {
                window.location.href = "${base}/member/order/viewv2.jhtml?sn=" + encodeURIComponent(orderId);
            }
        };
        //检测订单状态
        var statusTimer = null,
            lockTimer = null,
            orderId = null;
        var checkOrderStatus = function () {
            $.ajax({
                url: "${base}/member/order/check_payment.jhtml",
                type: "POST",
                data: { sn: orderId },
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data) {
                        window.location.href = "${base}/member/order/viewv2.jhtml?sn=" + encodeURIComponent(orderId);
                    }
                }
            }).always(function () {
                statusTimer = setTimeout(checkOrderStatus, 3000);
            });
        };
        var checkOrderLock = function () {
            $.ajax({
                url: "${base}/member/order/lock.jhtml",
                type: "POST",
                data: { sn: orderId },
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data) {
                        window.location.href = "${base}/member/order/view.jhtml?sn=" + encodeURIComponent(orderId);
                    }
                }
            }).always(function () {
                lockTimer = setTimeout(checkOrderLock, 3000);
            });
        };
        //新页面打开链接
        var openWindow = function (url) {
            window.open(url);
        };
        //注册事件
        $paymentRadio.find("input").click(paymentPluginChange);
        $province.change(getCityData);
        $addressId.change(addressChange);
        $addressEdit.click(showAddressUpdate);
        $addressForm.find("a.button").click(saveAddress);
        $btnBuy.click(doSubmit);
        $products.find(".product").each(function (i, e) {
            var $product = $(e);
            $product.find(".detail .purchase-info input").change(changeProductQty);
            $product.find(".title a.close").click(delProduct);
        });
        //过滤支付方式
        if (isMobile()) {
            $paymentRadio.find("input[value=alipayDirectPlugin]").parent().remove();
            $paymentRadio.find("input[value=tenpayNativePlugin]").parent().remove();
        }
        else {
            $paymentRadio.find("input[value=alipayWapPlugin]").parent().remove();
        }
        if (typeof WeixinJSBridge == "undefined") {
            $paymentRadio.find("input[value=tenpayJsapiPlugin]").parent().addClass("hidden");
            var onWeixinReaddy = function () {
                $paymentRadio.find("input[value=tenpayJsapiPlugin]").parent().removeClass("hidden");
            };
            if (document.addEventListener) {
                document.addEventListener('WeixinJSBridgeReady', onWeixinReaddy, false);
            } else if (document.attachEvent) {
                document.attachEvent('WeixinJSBridgeReady', onWeixinReaddy);
                document.attachEvent('onWeixinJSBridgeReady', onWeixinReaddy);
            }
        }
        if (!checkWeixinPayment()) {
            $paymentRadio.find("input[value=tenpayJsapiPlugin]").parent().off().prop("disabled", true)
                .children("h4").css({ color: "#cccccc" }).end()
                .children("p").css({ color: "red" }).text("需要微信5.0或更高版本");
        }
        //选择默认地址
        if (addressList && addressList.length) {
            var hasDefault = false;
            for (var i = 0; i < addressList.length; i++) {
                var address = addressList[i];
                if (address.isDefault) {
                    $addressId.val(address.id).change();
                    hasDefault = true;
                }
            }
            if(!hasDefault)
                $addressId.val(addressList[0].id).change();
        }
    </script>
</body>
</html>
