<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>FabriTailor</title>
    <link href="css/animate.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <link href="css/cart.css" rel="stylesheet" />
    <script src="js/modernizr.js"></script>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/jquery.alert.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/jquery.lazyload.js"></script>
    <script src="js/common.js"></script>
</head>
<body>
    <header>
        <div class="header-container">
            <a class="menu-btn show-on-small" href="javascript:void(0);"><img src="img/menu-btn.png" /></a>
            <div class="logo">
                <img src="img/logo.png" />
            </div>
            <nav class="hide-on-small">
                <ul>
                    <li><a href="javascript:void(0);"><span>在线定制</span></a></li>
                    <li><a href="javascript:void(0);"><span>关于我们</span></a></li>
                    <li><a href="javascript:void(0);"><span>凡布风尚</span></a></li>
                    <li><a href="javascript:void(0);"><span>休闲衬衫</span></a></li>
                    <li><a href="javascript:void(0);"><span>我们的凡布</span></a></li>
                </ul>
            </nav>
            <div class="btn-group hide-on-small">
                <a href="javascript:void(0);" class="register">从这里开始</a><a href="javascript:void(0);" class="login">登录</a>
            </div>
        </div>
    </header>
    <aside class="show-on-small">
        <a href="javascript:void(0);" class="btn-close"><img src="img/menu-btn-close.png" /></a>
        <ul>
            <li><a href="javascript:void(0);"><span>首页</span></a></li>
            <li>
                <a href="javascript:void(0);"><span>在线定制</span><i class="showhide"></i></a>
                <div class="sub-menu opened clearfix">
                    <a href="javascript:void(0);">查看全部</a>
                    <a href="javascript:void(0);">查看全部</a>
                    <a href="javascript:void(0);">查看全部</a>
                </div>
            </li>
            <li class="login"><a href="javascript:void(0);"><span>登录</span></a></li>
            <li class="logout hidden"><a href="javascript:void(0);"><span>登出</span></a></li>
            <li><a href="javascript:void(0);"><span>关于我们</span></a></li>
            <li><a href="javascript:void(0);"><span>凡布风尚</span></a></li>
            <li><a href="javascript:void(0);"><span>休闲衬衫</span></a></li>
            <li><a href="javascript:void(0);"><span>我们的凡布</span></a></li>
            <li class="account hidden">
                <a href="javascript:void(0);"><span>我的账号</span><i class="showhide"></i></a>
                <div class="sub-menu fadeInDownFast clearfix">
                    <a href="${base}/member/index.jhtml">账户信息</a>
                    <a href="${base}/member/order/list.jhtml">我的订单</a>
                    <a href="${base}/member/size/list.jhtml">我的尺寸</a>
                    <a href="${base}/member/specification/list.jhtml">我的板型</a>
                    <a href="${base}/member/receiver/list.jhtml">地址簿</a>
                    <a href="javascript:void(0);">退换货</a>
                </div>
            </li>
            <li class="register"><a class="button" href="javascript:void(0);">从这里开始</a></li>
        </ul>
    </aside>
    <div class="main-container">
        <div class="cart-categories">
            <h1>购物车</h1>
        </div>
        <div class="cart-empty">
            购物车是空的
        </div>
        <div class="products">
            <div class="product">
                <div class="title clearfix">
                    <h3>Hume</h3>
                    <div class="image">
                        <img src="img/product-detail1.jpg" />
                    </div>
                    <span>100%纯棉 小条纹格</span>
                    <a class="close" href="javascript:void(0);"></a>
                </div>
                <div class="detail">
                    <div class="build-name">
                        <ul class="clearfix">
                            <li>我的版型</li>
                            <li><a href="javascript:void(0);">编辑版型</a></li>
                        </ul>
                    </div>
                    <div class="build-content">
                        <ul class="clearfix">
                            <li>标准版</li>
                            <li>经典扣领</li>
                            <li>圆角袖口</li>
                            <li>无口袋</li>
                            <li>明门襟</li>
                            <li>无褶</li>
                            <li>加长</li>
                            <li>无刺绣</li>
                        </ul>
                    </div>
                    <div class="purchase-info">
                        <div class="qty">
                            <span>数量</span><input name="qty" class="input" type="text" value="1" />
                        </div>
                        <div class="price">
                            ￥999.00
                        </div>
                    </div>
                </div>
            </div>
            <div class="product">
                <div class="title clearfix">
                    <h3>Hume</h3>
                    <div class="image">
                        <img src="img/product-detail1.jpg" />
                    </div>
                    <span>100%纯棉 小条纹格</span>
                    <a class="close" href="javascript:void(0);"></a>
                </div>
                <div class="detail">
                    <div class="build-name">
                        <ul class="clearfix">
                            <li>我的版型</li>
                            <li><a href="javascript:void(0);">编辑版型</a></li>
                        </ul>
                    </div>
                    <div class="build-content">
                        <ul class="clearfix">
                            <li>标准版</li>
                            <li>经典扣领</li>
                            <li>圆角袖口</li>
                            <li>无口袋</li>
                            <li>明门襟</li>
                            <li>无褶</li>
                            <li>加长</li>
                            <li>无刺绣</li>
                        </ul>
                    </div>
                    <div class="purchase-info clearfix">
                        <div class="qty">
                            <span>数量</span><input name="qty" class="input" type="text" value="1" />
                        </div>
                        <div class="price">
                            ￥999.00
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="purchase row">
            <div class="col-md-4 col-sm-12">
                <h2>支付方式</h2>
                <div class="order-info">
                    <div class="radio clearfix">
                        <input name="paymentMethod" type="radio" value="alipay" />
                        <span></span>
                        <h4>支付宝</h4>
                        <p>支付宝描述</p>
                    </div>
                    <div class="radio clearfix">
                        <input name="paymentMethod" type="radio" value="weichatpay" />
                        <span></span>
                        <h4>微信</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-12">
                <h2>收货地址</h2>
                <div class="order-info">
                    <label>地址</label>
                    <select name="address_id" class="select">
                        <option value="">新建</option>
                    </select>
                    <div class="address-form">
                        <label>姓名</label>
                        <input name="name" class="input" type="text" />
                        <label class="margin">省市</label>
                        <select name="province" class="select">
                            <option value="">省市</option>
                        </select>
                        <label>区县</label>
                        <select name="city" class="select">
                            <option value="">区县</option>
                        </select>
                        <label class="margin">地址</label>
                        <input name="addr" class="input" type="text" />
                        <label class="margin">联系电话</label>
                        <input name="tel" class="input" type="text" />
                        <label class="margin">微信</label>
                        <input name="weichat" class="input" type="text" />
                        <div class="clearfix">
                            <a class="button" href="javascript:void(0);">保存</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-12">
                <h2>总计</h2>
                <div class="total">
                    <dl>
                        <dt>金额</dt>
                        <dd>¥24.00</dd>
                        <dt>优惠</dt>
                        <dd class="warn">¥0.00</dd>
                        <dt>返现</dt>
                        <dd>¥0.00</dd>
                        <dt>运费</dt>
                        <dd>¥10.00</dd>
                    </dl>
                    <dl class="sum">
                        <dt>总额</dt>
                        <dd>¥34.00</dd>
                    </dl>
                    <div class="clearfix">
                        <a class="button disabled" href="javascript:void(0);">购买</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="contact">
            <h3 class="hide-on-small">与凡布保持联系</h3>
            <div class="input-group hide-on-small">
                <input class="input" type="text" placeholder="请输入您的邮件地址" />
                <a href="javascript:void(0);" class="btn">»</a>
            </div>
            <div class="ico-link text-center-on-small">
                <a href="javascript:void(0);"><img src="img/ico-email.jpg" /></a>
                <a href="javascript:void(0);"><img src="img/ico-weibo.png" /></a>
                <a href="javascript:void(0);"><img src="img/ico-weixin.png" /></a>
                <a href="javascript:void(0);"><img src="img/ico-taobao.png" /></a>
            </div>
        </div>
        <div class="links text-center-on-small">
            <div class="row">
                <div class="col-md-3 col-sm-12">
                    <h6>FabriTailor.com</h6>
                    <ul>
                        <li>
                            <a href="javascript:void(0);">
                                北京市<br />
                                朝阳区<br />
                                夏家园18号楼<br />
                                2091室
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-12">
                    <h6>凡布制衣</h6>
                    <ul>
                        <li><a href="javascript:void(0);">关于我们</a></li>
                        <li><a href="javascript:void(0);">人才招聘</a></li>
                        <li><a href="javascript:void(0);">成为凡布量体师</a></li>
                        <li><a href="javascript:void(0);">服务条款</a></li>
                        <li><a href="javascript:void(0);">隐私声明</a></li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-12">
                    <h6>帮助</h6>
                    <ul>
                        <li><a href="javascript:void(0);">购物指南</a></li>
                        <li><a href="javascript:void(0);">关于量体定制</a></li>
                        <li><a href="javascript:void(0);">常见问题解答</a></li>
                        <li><a href="javascript:void(0);">帮助与支持</a></li>
                        <li><a href="javascript:void(0);">退换货信息</a></li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-12">
                    <h6>在线商店</h6>
                    <ul>
                        <li><a href="javascript:void(0);">衬衫</a></li>
                        <li><a href="javascript:void(0);">查看全部</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="logo">
            <img src="img/logo-footer.png" />
        </div>
    </footer>
    <div class="login-panel">
        <h2>登录</h2>
        <input class="input" type="text" placeholder="请输入电子邮件地址" />
        <input class="input" type="password" placeholder="请输入密码" />
        <a class="button" href="javascript:void(0);">登陆</a>
        <a href="javascript:void(0);">忘记密码，或立即免费注册成为会员？</a>
    </div>
    <div class="cover-small-black"></div>
    <div class="login-cover-black"></div>
    <script type="text/javascript">
        //侧边栏
        $("header .menu-btn").click(function () {
            $("aside").addClass("opened");
            $("div.cover-small-black").addClass("opened").fadeTo("normal", 0.5, EASING_NAME);
        });
        $("aside .btn-close").click(function () {
            $("aside").removeClass("opened");
            $("div.cover-small-black").fadeTo("normal", 0, EASING_NAME, function () { $(this).removeClass("opened"); });
        });
        var asideSubMenuInit = function (el) {
            var $li = $(el),
                $a = $li.children("a"),
                $subMenu = $li.children(".sub-menu");
            $a.click(function (e) {
                e.preventDefault();
                $a.next().toggleClass("opened").end().children("i.showhide").toggleClass("mins");
            });
        };
        asideSubMenuInit($("body > aside ul li.account"));
        //登陆
        var showLogin = function () {
            $(".login-panel").show();
            $("div.login-cover-black").addClass("opened").fadeTo("normal", 0.5, EASING_NAME);
        };
        var hideLogin = function () {
            $(".login-panel").hide();
            $("div.login-cover-black").fadeTo("normal", 0, EASING_NAME, function () { $(this).removeClass("opened"); });
        };
        $("div.login-cover-black").click(hideLogin);
        $("header .btn-group .login").click(showLogin);
    </script>
    <script type="text/javascript">
        var $purchase = $(".main-container .purchase"),
            $paymentRadio = $purchase.find(".radio"),
            $addressId = $purchase.find("select[name=address_id]"),
            $addressForm = $purchase.find(".address-form"),
            $name = $addressForm.find("input[name=name]"),
            $province = $addressForm.find("select[name=province]"),
            $city = $addressForm.find("select[name=city]"),
            $addr = $addressForm.find("input[name=addr]"),
            $tel = $addressForm.find("input[name=tel]"),
            $weichat = $addressForm.find("input[name=weichat]"),
            $btnBuy = $purchase.find(".total a.button");
        var addressList = [
            {
                id: 1,
                consignee: "",
                provinceId: 1,
                cityId: 2,
                address: "",
                phone: "",
                isDefault: true
            }
        ];
        //获取省市信息
        $.ajax({
            url: "${base}/common/area.jhtml",
            type: "GET",
            dataType: "json",
            cache: false,
            traditional: true,
            success: function (data) {
                if (data) {
                    for (var id in data) {
                        $province.append('<option value="' + id + '">' + data[id] + '</option>');
                    }
                }
            }
        });
        //获取区县信息
        var getCityData = function () {
            $city.children("option").not(":eq(0)").remove();
            if ($province.val() && $province.val().length) {
                $.ajax({
                    url: "${base}/common/area.jhtml",
                    type: "GET",
                    data: { parentId: $province.val() },
                    dataType: "json",
                    cache: false,
                    traditional: true,
                    success: function (data) {
                        if (data) {
                            for (var id in data) {
                                $city.append('<option value="' + id + '">' + data[id] + '</option>');
                            }
                            if ($city.data("value")) {
                                $city.val($city.data("value"));
                                $city.removeData("value");
                            }
                        }
                    }
                });
            }
        };
        //更改地址选择
        var addressChange = function () {
            var id = $addressId.val();
            if (!id || id.length == 0) {
                $addressForm.removeClass("hidden");
            }
            else {
                $addressForm.addClass("hidden");
            }
            validateForm();
        };
        //更改支付方式
        var paymentPluginChange = function () {
            var $radio = $(this).parent(),
                $container = $radio.parent(),
                val = $(this).val();
            if (!$container.data("val") || $container.data("val") != val) {
                $container.data("val", val);
                doCalculate();
                validateForm();
            }
        };
        //检测提交按钮状态
        var validateForm = function () {
            var isValide = true;
            if ($paymentRadio.find("input:checked").length == 0) {
                $paymentRadio.parent().addClass("has-error");
                isValide = false;
            }
            else {
                $paymentRadio.parent().removeClass("has-error");
            }
            if (!$addressId.val() || $addressId.val().length == 0) {
                $addressId.prev().addClass("has-error");
                isValide = false;
            }
            else {
                $addressId.prev().removeClass("has-error");
            }
            if (isValide) {
                $btnBuy.removeClass("disabled");
            }
            else {
                $btnBuy.addClass("disabled");
            }
            return isValide;
        };
        //重新计算订单数据
        var doCalculate = function (callback) {
            $btnBuy.addClass("calculating");
            var params = {
                paymentMethodId: 1,
                paymentPluginId: $paymentRadio.find("input:checked").val(),
                shippingMethodId: 1
            };
            $.ajax({
                url: "${base}/member/order/calculatev2.jhtml",
                type: "POST",
                data: params,
                dataType: "json",
                cache: false,
                traditional: true,
                success: function (data) {
                    if (data && data.message && data.message.type == "success") {
                        var total = $purchase.find(".total dd");
                        total.eq(0).text("￥" + (data.price || "0.00"));
                        total.eq(1).text("￥" + (data.couponDiscount || "0.00"));
                        total.eq(2).text("￥" + (data.promotionDiscount || "0.00"));
                        total.eq(3).text("￥" + (data.freight || "0.00"));
                        total.eq(3).text("￥" + (data.tax || "0.00"));
                        total.last().text("￥" + (data.amount || "0.00"));
                    }
                    if (typeof callback === "function")
                        callback.call(this, data);
                },
                error: function () {
                    if (typeof callback === "function")
                        callback.call(this, null);
                }
            }).always(function () {
                $btnBuy.removeClass("calculating");
            });
        };
        //提交订单
        var doSubmit = function () {
            if (!validateForm() || $(this).hasClass("loading"))
                return;
            var params = {
                cartToken: "${cartToken}",
                receiverId: $addressId.val(),
                paymentMethodId: 1,
                paymentPluginId: $paymentRadio.find("input:checked").val(),
                shippingMethodId: 1
            };
            $btnBuy.addClass("loading");
            $.ajax({
                url: "${base}/member/order/createv2.jhtml",
                type: "POST",
                data: params,
                dataType: "json",
                cache: false,
                traditional: true,
                success: function (data) {
                    if (data && data.type == "success") {
                        orderId = data.content;
                        doPayment();
                    }
                    else {
                        $.alert.error("提交订单失败。" + (data && data.content ? data.content : ""));
                    }
                },
                error: function () {
                    $.alert.error("提交订单失败。");
                }
            }).always(function () {
                $btnBuy.removeClass("loading");
            });
        };
        //进行支付
        var doPayment = function () {
            var paymentPluginId = $paymentRadio.find("input:checked").val();
            if (paymentPluginId == "tenpayNativePlugin") {
                openWindow("${base}/member/payment/submitv2?paymentPluginId=" + encodeURIComponent(paymentPluginId) + "&sn=" + encodeURIComponent(orderId));
                checkOrderStatus();
                checkOrderLock();
            }
        };
        //检测订单状态
        var statusTimer = null,
            lockTimer = null,
            orderId = null;
        var checkOrderStatus = function () {
            $.ajax({
                url: "${base}/member/order/check_payment.jhtml",
                type: "POST",
                data: { sn: orderId },
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data) {
                        window.location.href = "${base}/member/order/view.jhtml?sn=" + encodeURIComponent(orderId);
                    }
                }
            }).always(function () {
                statusTimer = setTimeout(checkOrderStatus, 3000);
            });
        };
        var checkOrderLock = function () {
            $.ajax({
                url: "${base}/member/order/lock.jhtml",
                type: "POST",
                data: { sn: orderId },
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data) {
                        window.location.href = "${base}/member/order/view.jhtml?sn=" + encodeURIComponent(orderId);
                    }
                }
            }).always(function () {
                lockTimer = setTimeout(checkOrderLock, 3000);
            });
        };
        //新页面打开链接
        var openWindow = function (url) {
            if (document.createEvent) {
                var a = $("<a href='" + encodeURIComponent(url) + "' target='_blank' >test</a>").get(0);
                var e = document.createEvent('MouseEvents');
                e.initEvent('click', true, true);
                a.dispatchEvent(e);
            }
            else {
                window.open(url);
            }
        };
        //注册事件
        $paymentRadio.find("input").click(paymentPluginChange);
        $province.change(getCityData);
        $addressId.change(addressChange);
        $btnBuy.click(doSubmit);
        //选择默认地址
        if (addressList && addressList.length) {
            var hasDefault = false;
            for (var i = 0; i < addressList.length; i++) {
                var address = addressList[i];
                if (address.isDefault) {
                    $addressId.val(address.id).change();
                    hasDefault = true;
                }
            }
            if(!hasDefault)
                $addressId.val(addressList[0].id).change();
        }
    </script>
</body>
</html>
